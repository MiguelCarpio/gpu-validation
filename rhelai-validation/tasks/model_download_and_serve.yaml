---
- name: Append --hf-token to model download args if specified
  set_fact:
    model_download_token_args: "--hf-token {{model_download_hf_token | quote}}"
  no_log: true
  when: model_download_hf_token

- name: Append --release to model download args if specified
  set_fact:
    model_download_release_args: "--release {{model_download_release | quote}}"
  when: model_download_release

- name: Download the inference model
  become_user: cloud-user
  command:
    cmd: ilab model download --repository {{[model_download_repository_base | regex_replace('/$', ''), model_name] | join('/') | regex_replace('^/','') | quote }} {{model_download_release_args | default('')}} {{model_download_token_args | default('')}}
    creates: "{{[model_path, 'model.safetensors'] | join('/') }}"
  vars:
    ansible_command_timeout: 3600

- name: Create user systemd directory
  file:
    path: /var/home/cloud-user/.config/systemd/user
    state: directory
    mode: '0755'
    owner: cloud-user
    group: cloud-user

- name: Create ilab systemd service on RHEL AI machine
  template:
    src: templates/ilab-serve.service.j2
    dest: /var/home/cloud-user/.config/systemd/user/ilab-serve.service
    owner: cloud-user
    group: cloud-user
    mode: '0755'
  register: serviceconfig

- name: Stop the model serving service
  when: serviceconfig.changed
  become_user: cloud-user
  command:
    cmd: systemctl --user stop ilab-serve.service

- name: Reload systemd config
  become_user: cloud-user
  command:
    cmd: systemctl --user daemon-reload

- name: Start the model serving service
  command:
    cmd: systemctl --user start ilab-serve.service
  become_user: cloud-user

- name: Wait for vllm API to appear
  command:
    cmd: curl -s --show-error http://localhost:8000/
  register: result
  until: result.rc == 0
  retries: 180  # 180 * 10 = 30 mins - this can be extremely slow in some environments https://github.com/containers/podman/issues/16541
  delay: 10

- name: Wait for vllm metrics endpoint to appear
  command:
    cmd: curl -s --show-error http://localhost:8000/
  register: result
  until: result.rc == 0
  retries: 12  # 12 * 10 = 2 mins after API appears
  delay: 10